<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APA Calculator (UC Housing Costs)</title>
  <style>
    :root {
      /* Lemon background + teal brand */
      --bg:#fff8cc;             /* light lemon */
      --card:#e6faf7;           /* pale teal */
      --muted:#465a5f;          /* soft grey-blue for text */
      --text:#243233;           /* dark text */
      --brand1:#0fb9b1;         /* teal */
      --brand2:#ffe66d;         /* lemon accent */
      --accent:#0aa79f;         /* darker teal */
      --border:#bfe9e2;         /* pale teal border */
      --divider:#d6efe9;
    }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap { max-width: 1100px; margin: 24px auto 64px; padding: 0 16px; }
    h1 { font-size: 28px; display:flex; align-items:center; gap:10px; color:var(--text); }
    h1 span.logo {
      width: 18px; height: 30px;
      background: linear-gradient(180deg,var(--brand1),var(--brand2));
      display:inline-block; border-radius: 6px; box-shadow: 0 8px 24px rgba(15,185,177,.25);
    }
    .grid { display:grid; grid-template-columns: repeat(12,1fr); gap:16px; }
    .card {
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 16px;
      padding:16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
    }
    label { font-size: 13px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select {
      width:100%; padding:12px; border-radius:12px;
      border:1px solid var(--border); background:#ffffff; color:var(--text);
      outline: none;
    }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(15,185,177,.18); }
    .muted { color: var(--muted); font-size: 13px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btn {
      appearance:none; border:none;
      background: linear-gradient(90deg,var(--brand1),var(--brand2));
      color:#1b1b1b; font-weight:800; padding:12px 14px; border-radius:12px; cursor:pointer;
    }
    .btn.secondary {
      background:#ffffff; color:var(--text); border:1px solid var(--border);
    }
    table { width:100%; border-collapse: collapse; background:#ffffff; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    th, td { padding:10px; border-bottom:1px solid var(--divider); text-align:left; font-size:14px; }
    th { background:#f9ffea; } /* very pale lemon for header */
    details > summary { cursor: pointer; }
    .no-results { padding: 12px; background:#ffffff; border:1px dashed var(--border); border-radius:12px; color:var(--muted); }
    small.code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin: 12px 0 16px; align-items:center; }
    .tab { padding:8px 12px; border-radius:10px; background:#ffffff; border:1px solid var(--border); color:var(--text); cursor:pointer; user-select:none; }
    .tab.active { color:#0b0f10; border-color:#ffd95e; background: linear-gradient(90deg,var(--brand2),#fffdf0); font-weight:800; }
    .tab-small { font-size: 12px; }
    .hidden { display:none; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:#ffffff; color:var(--text);}
    .intro { margin: 4px 0 10px; color: var(--text); font-weight:600; }
    footer.site-footer {
      position: sticky; bottom: 0; width: 100%;
    }
    .footer-inner {
      max-width: 1100px; margin: 0 auto; padding: 12px 16px;
      color: var(--accent);
      display:flex; align-items:center; justify-content:center; gap:8px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
    }
    .footer-inner a { color: var(--accent); text-decoration: none; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="logo"></span> APA Calculator <span class="muted">— UC Housing Costs</span></h1>

    <div class="tabs">
      <button class="tab active" id="tab-calc" aria-controls="panel-calc" aria-selected="true">Calculator</button>
      <button class="tab tab-small hidden" id="tab-settings" aria-controls="panel-settings" aria-selected="false" title="Admin">Settings</button>
      <span class="muted" id="admin-hint" style="margin-left:auto;">Press <span class="kbd">Alt</span> + <span class="kbd">S</span> for admin.</span>
    </div>

    <section id="panel-calc">
      <div class="grid">
        
        <div class="card" style="grid-column: span 5;">
          <h3 style="color:var(--accent); margin-top:0;">Inputs</h3>

          <!-- Mode toggle -->
          <div class="muted" style="margin-bottom:8px;">Choose one input method:</div>
          <div class="row" style="grid-template-columns:1fr 1fr;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="radio" name="mode" id="modeWeekly" checked>
              <span><strong>Weekly rents</strong></span>
            </label>
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="radio" name="mode" id="modeMonthly">
              <span><strong>Monthly rents</strong></span>
            </label>
          </div>

          <!-- Weekly block -->
          <div id="blockWeekly">
          <div class="info" style="margin:8px 0 6px; padding:8px 10px; background:#f0fffb; border:1px solid var(--border); border-radius:10px; color:var(--text);">
            Please input the rent <strong>minus any ineligible service charges</strong>.
          </div>

            <div class="row" style="margin-top:8px;">
              <div>
                <label>Weekly rent <strong>last year</strong> (£)</label>
                <input id="rentLast" type="number" step="0.01" placeholder="e.g. 115.38">
              </div>
              <div>
                <label>Weekly rent <strong>this year</strong> (£)</label>
                <input id="rentThis" type="number" step="0.01" placeholder="e.g. 126.92">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Rent-free weeks (0–4 typical)</label>
                <input id="rentFreeWeeks" type="number" step="1" min="0" max="10" value="0">
                <div class="muted">Monthly average uses <small class="code">weekly × (52 − rent‑free weeks) / 12</small>.</div>
              </div>
              <div>
                <label>APA in payment (per month) (£)</label>
                <input id="apa" type="number" step="0.01" placeholder="e.g. 336.96">
              </div>
            </div>
          </div>

          <!-- OR divider -->
          <div style="text-align:center; margin:10px 0; color:var(--muted); font-weight:700;">OR</div>

          <!-- Monthly block -->
          <div id="blockMonthly" class="sr-only" aria-hidden="true">
          <div class="info" style="margin:8px 0 6px; padding:8px 10px; background:#f0fffb; border:1px solid var(--border); border-radius:10px; color:var(--text);">
            Please input the rent <strong>minus any ineligible service charges</strong>.
          </div>

            <div class="row" style="margin-top:8px;">
              <div>
                <label>Monthly rent <strong>last year</strong> (£)</label>
                <input id="rentLastMonthly" type="number" step="0.01" placeholder="e.g. 500.00">
              </div>
              <div>
                <label>Monthly rent <strong>this year</strong> (£)</label>
                <input id="rentThisMonthly" type="number" step="0.01" placeholder="e.g. 540.00">
              </div>
            </div>
            <div class="row">
              <div>
                <label class="muted">Rent-free weeks</label>
                <input type="text" value="Not needed for monthly" disabled>
              </div>
              <div>
                <label>APA in payment (per month) (£)</label>
                <input id="apaMonthly" type="number" step="0.01" placeholder="e.g. 336.96">
              </div>
            </div>
          </div>
        </div>


        <div class="card" style="grid-column: span 7;">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <h3 style="color:var(--accent); margin-top:0;">Results</h3>
            <div>
              <button class="btn" id="run">Calculate</button>
              <button class="btn secondary" id="reset">Reset</button>
            </div>
          </div>

          <div class="intro">This payment is likely based on…</div>

          <table id="results">
            <thead>
              <tr>
                <th>Likely basis</th>
                <th>Monthly amount (£)</th>
                <th>Calculation</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="nores" class="no-results" style="display:none; margin-top:10px;">
            No exact HCE match was found for the APA amount. That suggests the shortfall may be due to <strong>income</strong>,
            <strong>benefit cap</strong>, <strong>sanctions</strong>, or other award components outside housing costs.
          </div>

          <!-- Disclaimer (always visible) -->
          <div class="card" style="margin-top:12px;">
            <h3 style="margin-top:0; color:var(--accent);">Disclaimer</h3>
            <p class="muted" style="line-height:1.5; color:var(--text);">
              This calculator is designed to identify why an APA managed payment to landlord might not be paying full for social landlords.
              It does not apply to private landlords. This calculator is designed to be as accurate as possible, but it may not reflect every
              individual circumstance. It should not be relied on as a substitute for professional advice. Please share feedback if you spot
              anything that could make it clearer or more accurate.
            </p>
            <p class="muted" style="margin-top:8px;">Feedback: <a href="mailto:pcarysforth1@gmail.com" style="color:var(--accent); font-weight:600;">pcarysforth1@gmail.com</a></p>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-settings" class="sr-only" aria-hidden="true" style="margin-top:16px;">
      <div class="grid">
        <div class="card" style="grid-column: span 12;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;"><h3 style="color:var(--accent); margin-top:0;">Settings</h3><button class="btn secondary" id="backToCalc" title="Return to Calculator">Back to Calculator</button></div>
          <div class="row">
            <div>
              <label>Liability shares to test</label>
              <select id="liability" multiple size="3">
                <option value="1" selected>100%</option>
                <option value="0.5" selected>50%</option>
                <option value="0.3333333333">33.3%</option>
              </select>
              <div class="muted">Hold Ctrl/Cmd to select multiple.</div>
            </div>
            <div>
              <label>Spare room deductions</label>
              <select id="spare" multiple size="3">
                <option value="0" selected>None (0%)</option>
                <option value="0.14" selected>One spare (14%)</option>
                <option value="0.25" selected>Two or more (25%)</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>HCC monthly rate <strong>old</strong> (£)</label>
              <input id="hccOld" type="number" step="0.01" value="91.47">
              <div class="muted">Update each April.</div>
            </div>
            <div>
              <label>HCC monthly rate <strong>new</strong> (£)</label>
              <input id="hccNew" type="number" step="0.01" value="93.02">
              <div class="muted">Update each April.</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Max non-dependants to test</label>
              <select id="maxNDeps">
                <option>0</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option selected>4</option>
              </select>
            </div>
            <div>
              <label>Use which rents</label>
              <select id="rentYear" multiple size="2">
                <option value="this" selected>This year's rent</option>
                <option value="last" selected>Last year's rent</option>
              </select>
              <div class="muted">Toggle if you only want to test one year.</div>
            </div>
          </div>

          <hr style="border:none; border-top:1px solid var(--border); margin:12px 0;">
          <h4 style="color:var(--accent);">Admin security</h4>
          <div class="muted" style="margin-bottom:8px;">Optional: set an admin password to open Settings with <span class="kbd">Alt</span>+<span class="kbd">S</span>.</div>
          <div class="row">
            <div>
              <label>New password</label>
              <input id="pw1" type="password" autocomplete="new-password">
            </div>
            <div>
              <label>Confirm password</label>
              <input id="pw2" type="password" autocomplete="new-password">
            </div>
          </div>
          <div style="margin-top:8px;">
            <button class="btn" id="savePw">Save password</button>
            <button class="btn secondary" id="clearPw">Clear password</button>
            <span class="muted" id="pwMsg" style="margin-left:8px;"></span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <div class="footer-inner">
      © Carysforth Creations • <a href="mailto:pcarysforth1@gmail.com">pcarysforth1@gmail.com</a>
    </div>
  </footer>

<script>
// --- Tabs ---
const tabCalc = document.getElementById('tab-calc');
const tabSettings = document.getElementById('tab-settings');
const panelCalc = document.getElementById('panel-calc');
const panelSettings = document.getElementById('panel-settings');
const adminHint = document.getElementById('admin-hint');

function showTab(which){
  if (which === 'settings'){
    tabCalc.classList.remove('active'); tabCalc.setAttribute('aria-selected','false');
    tabSettings.classList.add('active'); tabSettings.setAttribute('aria-selected','true');
    panelCalc.classList.add('sr-only'); panelCalc.setAttribute('aria-hidden','true');
    panelSettings.classList.remove('sr-only'); panelSettings.setAttribute('aria-hidden','false');
    location.hash = '#settings';
  } else {
    tabSettings.classList.remove('active'); tabSettings.setAttribute('aria-selected','false');
    tabCalc.classList.add('active'); tabCalc.setAttribute('aria-selected','true');
    panelSettings.classList.add('sr-only'); panelSettings.setAttribute('aria-hidden','true');
    panelCalc.classList.remove('sr-only'); panelCalc.setAttribute('aria-hidden','false');
    location.hash = '#calc';
  }
}

// Hide settings until unlocked
function unlockSettingsUI(){ tabSettings.classList.remove('hidden'); adminHint.classList.add('hidden'); }
function isPasswordSet(){ return !!localStorage.getItem('apa_admin_pw'); }

function promptPasswordIfNeeded(){
  if (!isPasswordSet()) { return true; }
  const guess = prompt('Enter admin password to open Settings:');
  if (guess === null) { return false; }
  const ok = guess === localStorage.getItem('apa_admin_pw');
  if (!ok) alert('Incorrect password');
  return ok;
}

// Keyboard shortcut Alt+S
document.addEventListener('keydown', (e)=>{
  if (e.altKey && (e.key === 's' || e.key === 'S')){
    if (promptPasswordIfNeeded()){
      unlockSettingsUI();
      showTab('settings');
    }
  }
});

// Allow direct deep-link if user already unlocked and (optionally) password ok
if (location.hash === '#settings'){
  if (promptPasswordIfNeeded()){
    unlockSettingsUI();
    showTab('settings');
  } else {
    showTab('calc');
  }
}

// Password management in Settings
const pw1 = document.getElementById('pw1');
const pw2 = document.getElementById('pw2');
const savePw = document.getElementById('savePw');
const clearPw = document.getElementById('clearPw');
const pwMsg = document.getElementById('pwMsg');
document.getElementById('backToCalc')?.addEventListener('click', ()=> showTab('calc'));

savePw?.addEventListener('click', ()=>{
  if (pw1.value !== pw2.value){ pwMsg.textContent = 'Passwords do not match.'; pwMsg.style.color = '#c0392b'; return; }
  if (!pw1.value){ pwMsg.textContent = 'Password cannot be empty.'; pwMsg.style.color = '#c0392b'; return; }
  localStorage.setItem('apa_admin_pw', pw1.value);
  pw1.value = pw2.value = '';
  pwMsg.textContent = 'Admin password saved.'; pwMsg.style.color = '#2e7d32';
});
clearPw?.addEventListener('click', ()=>{
  localStorage.removeItem('apa_admin_pw');
  pwMsg.textContent = 'Password cleared.'; pwMsg.style.color = '#2e7d32';
});


// Money helpers in **pence**.
function toPence(x){ return Math.round(parseFloat(x||'0') * 100); }
function fromPence(p){ return (p/100).toFixed(2); }
function applyPercentPence(pence, ratio){ return Math.round(pence * ratio); }

function monthsFromWeeklyPence(weeklyP, rentFreeWeeks){
  const weeksCharged = 52 - rentFreeWeeks;
  const monthly = (weeklyP * weeksCharged) / 12;
  return Math.round(monthly);
}

// Mode toggle logic
const modeWeekly = document.getElementById('modeWeekly');
const modeMonthly = document.getElementById('modeMonthly');
const blockWeekly = document.getElementById('blockWeekly');
const blockMonthly = document.getElementById('blockMonthly');
function updateMode(){
  const monthly = modeMonthly.checked;
  if (monthly){
    blockMonthly.classList.remove('sr-only'); blockMonthly.setAttribute('aria-hidden','false');
    blockWeekly.classList.add('sr-only'); blockWeekly.setAttribute('aria-hidden','true');
  } else {
    blockWeekly.classList.remove('sr-only'); blockWeekly.setAttribute('aria-hidden','false');
    blockMonthly.classList.add('sr-only'); blockMonthly.setAttribute('aria-hidden','true');
  }
}
modeWeekly.addEventListener('change', updateMode);
modeMonthly.addEventListener('change', updateMode);

// Label helpers
function spareLabel(s){
  if (s === 0) return 'no spare rooms';
  if (Math.abs(s - 0.14) < 1e-9) return 'reduced by one room';
  return 'reduced by two or more rooms';
}
function baseLabel(lbl){
  return lbl === 'this' ? "this year's rent" : "last year's rent";
}

// Scenario generator
function generateScenarios({baseMonthlyThisP, baseMonthlyLastP, liabilities, spareRates, maxNDeps, hccOldP, hccNewP}){
  const bases = [];
  if (!isNaN(baseMonthlyThisP)) bases.push({key:'this', baseMonthlyP: baseMonthlyThisP});
  if (!isNaN(baseMonthlyLastP)) bases.push({key:'last', baseMonthlyP: baseMonthlyLastP});

  const hccRates = [hccOldP, hccNewP]; // numeric only

  const out = [];
  for (const base of bases){
    const baseMonthlyP = base.baseMonthlyP; // already monthly (weekly-converted or direct monthly)
    for (const L of liabilities){
      const baseLP = applyPercentPence(baseMonthlyP, L);
      for (const s of spareRates){
        const afterSpareP = applyPercentPence(baseLP, (1 - s));
        // Zero HCC case
        out.push({
          pence: afterSpareP,
          label: `${baseLabel(base.key)} · liability ${Math.round(L*100)}% · ${spareLabel(s)} · no HCC`,
          calc: `(${fromPence(baseMonthlyP)} × ${Math.round(L*100)}% × ${s===0? '100%': (100 - s*100)+'%'})`
        });
        for (let n=1; n<=maxNDeps; n++){
          for (const rate of hccRates){
            const monthlyP = afterSpareP - n*rate;
            out.push({
              pence: monthlyP,
              label: `${baseLabel(base.key)} · liability ${Math.round(L*100)}% · ${spareLabel(s)} · ${n} HCC`,
              calc: `(${fromPence(baseMonthlyP)} × ${Math.round(L*100)}% × ${s===0? '100%': (100 - s*100)+'%'} − ${n}×${fromPence(rate)})`
            });
          }
        }
      }
    }
  }
  return out;
}

function run(){
  // Settings (hidden/admin)
  const liabilities = Array.from(document.getElementById('liability').selectedOptions).map(o=>parseFloat(o.value));
  const spareRates = Array.from(document.getElementById('spare').selectedOptions).map(o=>parseFloat(o.value));
  const maxNDeps = parseInt(document.getElementById('maxNDeps').value||'4',10);
  const rentYears = Array.from(document.getElementById('rentYear').selectedOptions).map(o=>o.value);
  const hccOldP = toPence(document.getElementById('hccOld').value);
  const hccNewP = toPence(document.getElementById('hccNew').value);

  let baseMonthlyThisP = NaN, baseMonthlyLastP = NaN, apaP = NaN;

  if (modeMonthly.checked){
    // Monthly mode
    const rentThisMonthlyP = toPence(document.getElementById('rentThisMonthly').value);
    const rentLastMonthlyP = toPence(document.getElementById('rentLastMonthly').value);
    const apaMonthlyP = toPence(document.getElementById('apaMonthly').value);
    // Only include years that are selected in Settings
    if (rentYears.includes('this')) baseMonthlyThisP = rentThisMonthlyP;
    if (rentYears.includes('last')) baseMonthlyLastP = rentLastMonthlyP;
    apaP = apaMonthlyP;
  } else {
    // Weekly mode
    const rentThisP_weekly = toPence(document.getElementById('rentThis').value);
    const rentLastP_weekly = toPence(document.getElementById('rentLast').value);
    const rentFreeWeeks = parseInt(document.getElementById('rentFreeWeeks').value||'0',10);
    const apaP_weekly = toPence(document.getElementById('apa').value);

    if (rentYears.includes('this')) baseMonthlyThisP = monthsFromWeeklyPence(rentThisP_weekly, rentFreeWeeks);
    if (rentYears.includes('last')) baseMonthlyLastP = monthsFromWeeklyPence(rentLastP_weekly, rentFreeWeeks);
    apaP = apaP_weekly;
  }

  const scenarios = generateScenarios({baseMonthlyThisP, baseMonthlyLastP, liabilities, spareRates, maxNDeps, hccOldP, hccNewP});
  const matches = scenarios.filter(s => s.pence === apaP);

  const tbody = document.querySelector('#results tbody');
  tbody.innerHTML = '';
  document.getElementById('nores').style.display = matches.length ? 'none' : 'block';

  matches.forEach(m => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${m.label}</td>
      <td>£${fromPence(m.pence)}</td>
      <td><details><summary>Show calc</summary><div class="muted">${m.calc}</div></details></td>
    `;
    tbody.appendChild(tr);
  });
}

// Reset still only clears current visible block
document.getElementById('run').addEventListener('click', run);
document.getElementById('reset').addEventListener('click', ()=>{
  if (modeMonthly.checked){
    document.getElementById('rentLastMonthly').value='';
    document.getElementById('rentThisMonthly').value='';
    document.getElementById('apaMonthly').value='';
  } else {
    document.getElementById('rentLast').value='';
    document.getElementById('rentThis').value='';
    document.getElementById('rentFreeWeeks').value='0';
    document.getElementById('apa').value='';
  }
  document.querySelector('#results tbody').innerHTML='';
  document.getElementById('nores').style.display = 'none';
});
updateMode();

</script>
</body>
</html>
